!function(t){t.fn.cacheImages=function(e){this.cacheImagesConfig=t.extend({},t.fn.cacheImages.defaults,e),this.cacheImagesConfig.encodeOnCanvas="undefined"!=typeof HTMLCanvasElement&&this.cacheImagesConfig.encodeOnCanvas,"boolean"!=typeof this.cacheImagesConfig.forceSave&&(this.cacheImagesConfig.forceSave=!1);var n=this;return"function"==typeof this.cacheImagesConfig.start&&n.cacheImagesConfig.start(this),!1===t.fn.cacheImages.testOutput(this.cacheImagesConfig.defaultImage,!0)&&(this.cacheImagesConfig.defaultSrc=this.cacheImagesConfig.defaultImage),this.each(function(e,a){t.fn.cacheImages.storageAvailable(t(a),e,a,function(e,c){var s,g=t(c);if("IMG"===g.prop("tagName")?(g.data("cachedImageType","src"),s=g.prop("src")||g.data("cachedImageSrc"),null!==n.cacheImagesConfig.url&&(s=n.cacheImagesConfig.url,g.prop("src",""))):(g.data("cachedImageType","css"),s=g.css("background-image").replace(/"/g,"").replace(/url\(|\)$/gi,"")||g.data("cachedImageSrc"),null!==n.cacheImagesConfig.url&&(s=n.cacheImagesConfig.url,g.css("background-image","url()"))),void 0===s)return t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Error - no URI to load"),n.cacheImagesConfig.fail.call(this),n.cacheImagesConfig.always.call(this),!0;if(void 0!==g.prop("src")&&t.fn.cacheImages.testOutput(g.prop("src"),!0))return t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: already displaying cached image"),n.cacheImagesConfig.done.call(this),n.cacheImagesConfig.always.call(this),!0;var a=n.cacheImagesConfig.storagePrefix+":"+s;t.fn.cacheImages.get(g,a,function(a,e){if(0==n.cacheImagesConfig.forceSave&&e&&t.fn.cacheImages.testOutput(e,!0))return this.data("cachedImageSrc",s),"src"==this.data("cachedImageType")?this.prop("src",e):this.css("background-image","url("+e+")"),t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Already Encoded"),n.cacheImagesConfig.done.call(this,e),void n.cacheImagesConfig.always.call(this);if("pending"===e)return t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Caching in Progress - "+s),n.cacheImagesConfig.fail.call(this),void n.cacheImagesConfig.always.call(this);"src"==this.data("cachedImageType")?this.prop("src",""):this.css("background-image","url()");e=s.match(/\.(jpg|jpeg|png|gif)$/i);if(e&&e.length&&(e="jpg"==e[1].toLowerCase()?"jpeg":e[1].toLowerCase()),void 0===e)return n.cacheImagesConfig.fail.call(this),void n.cacheImagesConfig.always.call(this);this.data("cachedImageSrc",s),t.fn.cacheImages.set(this,a,"pending",function(e,a){}),n.cacheImagesConfig.encodeOnCanvas&&"gif"!==e?(t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Preparing to Cache : canvas - "+s),g.on("load",function(){newSrc=t.fn.cacheImages.base64EncodeCanvas(c),t.fn.cacheImages.set(this,a,newSrc),t.fn.cacheImages.testOutput(newSrc,!0)?("src"==this.data("cachedImageType")?this.prop("src",newSrc):this.css("background-image","url("+newSrc+")"),this.is(".cacheImagesRemove")&&this.remove(),n.cacheImagesConfig.done.call(this,newSrc)):n.cacheImagesConfig.fail.call(this),n.cacheImagesConfig.always.call(this)})):(t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Preparing to Cache : base64 - "+s),t.fn.cacheImages.base64EncodeImg(c,function(e){t.fn.cacheImages.set(this,a,e,function(){this.is(".cacheImagesRemove")&&this.remove(),"src"==this.data("cachedImageType")?this.prop("src",e):this.css("background-image","url("+e+")"),n.cacheImagesConfig.done.call(this,e),n.cacheImagesConfig.always.call(this)})}))})})})},t.fn.cacheImages.defaults={storagePrefix:"FV-cacheImage",url:null,forceSave:!1,defaultImage:null,encodeOnCanvas:!1,done:function(){},fail:function(){},always:function(){},start:function(){},debug:!1},t.fn.cacheImages.storageAvailable=function(e,a,c,s){if("undefined"==typeof localStorage)return t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Error - No Storage Support"),t.fn.cacheImages.defaults.fail.call(this,"FV.cacheImage: Error - No Storage Support"),t.fn.cacheImages.defaults.always.call(this),!1;s(a,c)},t.fn.cacheImages.base64EncodeImg=function(e,c){var s=new Image;s.onload=function(){var e=document.createElement("CANVAS"),a=e.getContext("2d");e.height=s.height,e.width=s.width,a.drawImage(s,0,0),c(e.toDataURL("image/png")),e=null},s.src=e.src},t.fn.cacheImages.base64EncodeCanvas=function(e){var a=document.createElement("CANVAS"),c=a.getContext("2d");return a.height=e.height,a.width=e.width,c.drawImage(e,0,0),e=a.toDataURL("image/png"),a=null,e},t.fn.cacheImages.testOutput=function(e,a){return void 0!==e&&(!0!==a||""!==e)},t.fn.cacheImages.set=function(e,a,c,s){try{localStorage.setItem(a,c),t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Stored - "+a),s(a,c)}catch(e){t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Failed - "+a),s(a,c)}},t.fn.cacheImages.get=function(e,a,c){try{var s=localStorage.getItem(a);c(a,null!=s&&s)}catch(e){t.fn.cacheImages.defaults.debug&&console.log("FV.cacheImage: Failed Retrieval - "+a),c(a,!1)}}}(jQuery);
